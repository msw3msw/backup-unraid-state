<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Backup Unraid State</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        :root {
            --primary: #ff8c2f;
            --primary-hover: #ff9f4f;
            --bg-dark: #0a0a0a;
            --bg-card: #141414;
            --bg-input: #1a1a1a;
            --bg-log: #0d0d0d;
            --border: #2a2a2a;
            --border-highlight: #3a3a3a;
            --text: #e5e5e5;
            --text-muted: #737373;
            --success: #22c55e;
            --error: #ef4444;
        }
        
        * { box-sizing: border-box; }
        
        body {
            background: var(--bg-dark);
            color: var(--text);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            font-size: 14px;
            min-height: 100vh;
        }
        
        .navbar {
            background: var(--bg-card) !important;
            border-bottom: 1px solid var(--border);
            padding: 0.75rem 1.5rem;
        }
        .navbar-brand { color: var(--primary) !important; font-weight: 700; font-size: 1.1rem; }
        .status-dot {
            width: 8px; height: 8px;
            background: var(--success);
            border-radius: 50%;
            display: inline-block;
        }
        .status-dot.running { background: var(--primary); animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
        
        .nav-tabs {
            border-bottom: 1px solid var(--border);
            background: var(--bg-card);
            padding: 0 1rem;
        }
        .nav-tabs .nav-link {
            color: var(--text-muted); border: none;
            padding: 0.875rem 1.25rem; font-weight: 500; font-size: 13px;
        }
        .nav-tabs .nav-link:hover { color: var(--text); }
        .nav-tabs .nav-link.active { color: var(--primary); background: transparent; border-bottom: 2px solid var(--primary); }
        
        .main-container { max-width: 1400px; margin: 0 auto; padding: 1.5rem; }
        
        .dashboard-card {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: 12px; padding: 1rem 1.5rem; margin-bottom: 1.5rem;
        }
        .stat-row { display: flex; flex-wrap: wrap; gap: 2rem; }
        .stat-item { display: flex; gap: 0.5rem; font-size: 13px; }
        .stat-label { color: var(--text-muted); }
        .stat-value { color: var(--text); font-weight: 500; }
        
        .cards-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.5rem; }
        @media (max-width: 1024px) { .cards-grid { grid-template-columns: 1fr; } }
        
        .backup-card {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: 12px; min-height: 420px;
            display: flex; flex-direction: column; overflow: hidden;
        }
        .backup-card.critical { border-color: var(--primary); }
        .backup-card.running { border-color: var(--success); box-shadow: 0 0 20px rgba(34, 197, 94, 0.15); }
        
        .card-header-custom {
            padding: 0.875rem 1.25rem; border-bottom: 1px solid var(--border);
            font-weight: 600; font-size: 14px;
            display: flex; align-items: center; gap: 0.5rem;
        }
        .backup-card.critical .card-header-custom { color: var(--primary); }
        .badge-critical { background: var(--error); color: #fff; font-size: 10px; padding: 2px 6px; border-radius: 4px; }
        
        .card-controls { flex: 1; padding: 1.25rem; display: flex; flex-direction: column; gap: 1rem; }
        .card-cta { padding: 0 1.25rem 1rem; }
        
        .progress-container { padding: 0 1.25rem 0.75rem; display: none; }
        .progress-container.active { display: block; }
        .progress-track { width: 100%; height: 6px; background: var(--bg-input); border-radius: 3px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--primary); border-radius: 3px; transition: width 0.3s ease; }
        .progress-fill.complete { background: var(--success); }
        .progress-fill.error { background: var(--error); }
        
        .card-log {
            border-top: 1px solid var(--border); background: var(--bg-log);
            padding: 0.75rem 1rem; height: 110px; overflow-y: auto;
            font-family: 'SF Mono', Monaco, 'Courier New', monospace; font-size: 11px;
        }
        .card-log::-webkit-scrollbar { width: 4px; }
        .card-log::-webkit-scrollbar-track { background: transparent; }
        .card-log::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }
        .log-line { color: var(--text-muted); line-height: 1.6; }
        .log-line.success { color: var(--success); }
        .log-line.error { color: var(--error); }
        .log-idle { color: var(--text-muted); font-style: italic; }
        
        .form-label { color: var(--text) !important; font-size: 12px; font-weight: 500; margin-bottom: 0.375rem; }
        .form-control, .form-select {
            background: var(--bg-input); border: 1px solid var(--border);
            color: var(--text); font-size: 13px; padding: 0.5rem 0.75rem; border-radius: 6px;
        }
        .form-control:focus, .form-select:focus {
            background: var(--bg-input); border-color: var(--primary);
            color: var(--text); box-shadow: 0 0 0 2px rgba(255, 140, 47, 0.15);
        }
        .form-check-input { background-color: var(--bg-input); border-color: var(--border); }
        .form-check-input:checked { background-color: var(--primary); border-color: var(--primary); }
        .form-check-label { color: var(--text) !important; font-size: 13px; }
        
        .btn-primary {
            background: var(--primary); border: none; color: #000;
            font-weight: 600; padding: 0.625rem 1rem; font-size: 13px; border-radius: 8px;
        }
        .btn-primary:hover { background: var(--primary-hover); color: #000; }
        .btn-primary:disabled { background: var(--primary); opacity: 0.6; cursor: not-allowed; }
        .btn-outline-secondary { border-color: var(--border); color: var(--text-muted); }
        .btn-outline-secondary:hover { background: var(--bg-input); border-color: var(--border-highlight); color: var(--text); }
        
        .day-btn {
            width: 40px; height: 32px; border-radius: 6px;
            border: 1px solid var(--border); background: var(--bg-input);
            color: var(--text-muted); font-size: 11px; font-weight: 600; cursor: pointer;
        }
        .day-btn:hover { border-color: var(--border-highlight); color: var(--text); }
        .day-btn.active { background: var(--primary); border-color: var(--primary); color: #000; }
        
        .settings-section {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: 12px; padding: 1.25rem; margin-bottom: 1.5rem;
        }
        .settings-section h6 { font-size: 14px; font-weight: 600; margin-bottom: 1rem; }
        
        .path-item { display: flex; align-items: center; gap: 0.75rem; padding: 0.5rem 0; font-size: 13px; }
        .path-item code { color: var(--primary); background: rgba(255, 140, 47, 0.1); padding: 2px 8px; border-radius: 4px; font-size: 12px; }
        
        .exclude-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem; max-height: 180px; overflow-y: auto; }
        @media (max-width: 768px) { .exclude-grid { grid-template-columns: repeat(2, 1fr); } }
        
        .backup-list { background: var(--bg-input); border-radius: 8px; overflow: hidden; }
        .backup-list-header {
            display: grid; grid-template-columns: 1fr 100px 70px 70px; gap: 0.5rem;
            padding: 0.5rem 0.75rem; background: var(--bg-card);
            font-size: 10px; font-weight: 600; color: var(--text-muted); text-transform: uppercase;
        }
        .backup-list-item {
            display: grid; grid-template-columns: 1fr 100px 70px 70px; gap: 0.5rem;
            padding: 0.5rem 0.75rem; border-top: 1px solid var(--border); font-size: 12px; align-items: center;
        }
        
        .full-log {
            background: var(--bg-log); border: 1px solid var(--border);
            border-radius: 8px; padding: 1rem; height: 500px; overflow-y: auto;
            font-family: 'SF Mono', Monaco, 'Courier New', monospace; font-size: 12px;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="container-fluid">
            <span class="navbar-brand"><i class="bi bi-hdd-stack me-2"></i>Backup Unraid State</span>
            <span class="text-muted small">
                <span class="status-dot" id="globalStatus"></span>
                <span class="ms-2" id="globalStatusText">Idle</span>
            </span>
        </div>
    </nav>

    <ul class="nav nav-tabs" id="mainTabs">
        <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#backup"><i class="bi bi-cloud-upload me-1"></i>Backup Now</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#schedule"><i class="bi bi-clock me-1"></i>Schedule</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#restore"><i class="bi bi-cloud-download me-1"></i>Restore</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#settings"><i class="bi bi-gear me-1"></i>Settings</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#logs"><i class="bi bi-journal-text me-1"></i>Logs</button></li>
    </ul>

    <div class="main-container">
        <div class="tab-content">
            <!-- BACKUP NOW TAB -->
            <div class="tab-pane fade show active" id="backup">
                <div class="dashboard-card">
                    <div class="stat-row">
                        <div class="stat-item"><span class="stat-label">Last VM Backup:</span><span class="stat-value" id="statsLastVm">—</span></div>
                        <div class="stat-item"><span class="stat-label">Last Appdata Backup:</span><span class="stat-value" id="statsLastAppdata">—</span></div>
                        <div class="stat-item"><span class="stat-label">Total Backup Size:</span><span class="stat-value" id="statsTotalSize">0.0 B</span></div>
                        <div class="stat-item"><span class="stat-label">Next Scheduled:</span><span class="stat-value" id="statsNextScheduled">—</span></div>
                    </div>
                </div>

                <div class="cards-grid">
                    <!-- VM Backup Card -->
                    <div class="backup-card" id="vmCard">
                        <div class="card-header-custom"><i class="bi bi-pc-display"></i>VM Backup</div>
                        <div class="card-controls">
                            <div><label class="form-label">Select VM</label><select class="form-select" id="vmSelect"><option>Loading...</option></select></div>
                            <div><label class="form-label">VM Handling</label><select class="form-select" id="vmHandling"><option value="stop">Stop VM during backup</option><option value="live">Live backup</option></select></div>
                            <div class="form-check"><input class="form-check-input" type="checkbox" id="vmCompress" checked><label class="form-check-label" for="vmCompress">Compress backup</label></div>
                        </div>
                        <div class="card-cta"><button class="btn btn-primary w-100" id="vmBackupBtn" onclick="startBackup('vm')"><i class="bi bi-play-fill me-1"></i>Start VM Backup</button></div>
                        <div class="progress-container" id="vmProgress"><div class="progress-track"><div class="progress-fill" id="vmProgressFill"></div></div></div>
                        <div class="card-log" id="vmLog"><div class="log-idle">Waiting for user action…</div></div>
                    </div>

                    <!-- Appdata Backup Card -->
                    <div class="backup-card" id="appdataCard">
                        <div class="card-header-custom"><i class="bi bi-folder"></i>Appdata Backup</div>
                        <div class="card-controls">
                            <div><label class="form-label">Backup Mode</label>
                                <div class="form-check"><input class="form-check-input" type="radio" name="appdataMode" id="appdataModeAll" value="all" checked><label class="form-check-label" for="appdataModeAll">Backup all folders (<span id="folderCount">0</span> apps)</label></div>
                                <div class="form-check"><input class="form-check-input" type="radio" name="appdataMode" id="appdataModeCustom" value="custom"><label class="form-check-label" for="appdataModeCustom">Select specific</label></div>
                            </div>
                            <div id="folderListContainer" style="display:none;"><div class="exclude-grid" id="folderList"></div></div>
                        </div>
                        <div class="card-cta"><button class="btn btn-primary w-100" id="appdataBackupBtn" onclick="startBackup('appdata')"><i class="bi bi-play-fill me-1"></i>Start Appdata Backup</button></div>
                        <div class="progress-container" id="appdataProgress"><div class="progress-track"><div class="progress-fill" id="appdataProgressFill"></div></div></div>
                        <div class="card-log" id="appdataLog"><div class="log-idle">Waiting for user action…</div></div>
                    </div>

                    <!-- Plugins Backup Card -->
                    <div class="backup-card" id="pluginsCard">
                        <div class="card-header-custom"><i class="bi bi-puzzle"></i>Plugins Backup</div>
                        <div class="card-controls">
                            <p class="small mb-1" style="color: var(--text);">Backup all plugin configurations from:</p>
                            <p class="small mb-0" style="color: var(--text-muted); font-family: monospace;">/boot/config/plugins/</p>
                        </div>
                        <div class="card-cta"><button class="btn btn-primary w-100" id="pluginsBackupBtn" onclick="startBackup('plugins')"><i class="bi bi-play-fill me-1"></i>Start Plugins Backup</button></div>
                        <div class="progress-container" id="pluginsProgress"><div class="progress-track"><div class="progress-fill" id="pluginsProgressFill"></div></div></div>
                        <div class="card-log" id="pluginsLog"><div class="log-idle">Waiting for user action…</div></div>
                    </div>

                    <!-- Flash Backup Card -->
                    <div class="backup-card critical" id="flashCard">
                        <div class="card-header-custom"><i class="bi bi-usb-drive"></i>Flash Backup<span class="badge-critical ms-2">CRITICAL</span></div>
                        <div class="card-controls">
                            <p class="small mb-2" style="color: var(--text);"><strong>Disaster Recovery Backup</strong></p>
                            <div class="small" style="color: #b0b0b0; line-height: 1.8;">
                                • Array configuration<br>
                                • Network settings<br>
                                • User accounts<br>
                                • Docker &amp; VM settings<br>
                                • SSL &amp; License
                            </div>
                        </div>
                        <div class="card-cta"><button class="btn btn-primary w-100" id="flashBackupBtn" onclick="startBackup('flash')"><i class="bi bi-shield-check me-1"></i>Start Flash Backup</button></div>
                        <div class="progress-container" id="flashProgress"><div class="progress-track"><div class="progress-fill" id="flashProgressFill"></div></div></div>
                        <div class="card-log" id="flashLog"><div class="log-idle">Waiting for user action…</div></div>
                    </div>
                </div>
            </div>

            <!-- SCHEDULE TAB -->
            <div class="tab-pane fade" id="schedule">
                <div class="settings-section">
                    <h6><i class="bi bi-calendar-check me-2"></i>Scheduled Backups</h6>
                    <div class="row g-4 align-items-end">
                        <div class="col-auto">
                            <label class="form-label">Enable</label>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="scheduleEnabled" {% if schedule.enabled %}checked{% endif %} style="width:2.5em;height:1.25em;">
                                <label class="form-check-label" for="scheduleEnabled">Scheduled Backups</label>
                            </div>
                        </div>
                        <div class="col-auto">
                            <label class="form-label">Time</label>
                            <input type="time" class="form-control" id="scheduleTime" value="{{ schedule.time }}" style="width:120px;">
                        </div>
                        <div class="col-auto">
                            <label class="form-label">Days</label>
                            <div class="d-flex gap-1">
                                {% for day in ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'] %}
                                <button type="button" class="day-btn {% if day.lower() in schedule.days %}active{% endif %}" data-day="{{ day.lower() }}" onclick="toggleDay(this)">{{ day }}</button>
                                {% endfor %}
                            </div>
                        </div>
                        <div class="col-auto">
                            <label class="form-label">Naming</label>
                            <select class="form-select" id="scheduleNaming" style="width:120px;">
                                <option value="weekly" {% if schedule.naming_scheme == 'weekly' %}selected{% endif %}>Weekly</option>
                                <option value="daily" {% if schedule.naming_scheme == 'daily' %}selected{% endif %}>Daily</option>
                                <option value="monthly" {% if schedule.naming_scheme == 'monthly' %}selected{% endif %}>Monthly</option>
                            </select>
                        </div>
                        <div class="col">
                            <label class="form-label">What to Backup</label>
                            <div class="d-flex flex-wrap gap-3">
                                <div class="form-check"><input class="form-check-input" type="checkbox" id="scheduleVm" {% if schedule.vm_enabled %}checked{% endif %}><label class="form-check-label" for="scheduleVm">VMs</label></div>
                                <div class="form-check"><input class="form-check-input" type="checkbox" id="scheduleAppdata" {% if schedule.appdata_enabled %}checked{% endif %}><label class="form-check-label" for="scheduleAppdata">Appdata</label></div>
                                <div class="form-check"><input class="form-check-input" type="checkbox" id="schedulePlugins" {% if schedule.plugins_enabled %}checked{% endif %}><label class="form-check-label" for="schedulePlugins">Plugins</label></div>
                                <div class="form-check"><input class="form-check-input" type="checkbox" id="scheduleFlash" {% if schedule.flash_enabled %}checked{% endif %}><label class="form-check-label" for="scheduleFlash">Flash <span class="badge-critical">Critical</span></label></div>
                            </div>
                        </div>
                    </div>
                    <button class="btn btn-primary w-100 mt-4" onclick="saveSchedule()"><i class="bi bi-check-lg me-1"></i>Save Schedule</button>
                </div>
            </div>

            <!-- RESTORE TAB -->
            <div class="tab-pane fade" id="restore">
                <div class="row g-4">
                    <div class="col-md-6"><div class="settings-section"><h6><i class="bi bi-pc-display me-2"></i>VM Backups</h6><div class="backup-list" id="vmBackupsList"><p class="text-muted small p-3 m-0">Loading...</p></div></div></div>
                    <div class="col-md-6"><div class="settings-section"><h6><i class="bi bi-folder me-2"></i>Appdata Backups</h6><div class="backup-list" id="appdataBackupsList"><p class="text-muted small p-3 m-0">Loading...</p></div></div></div>
                    <div class="col-md-6"><div class="settings-section"><h6><i class="bi bi-puzzle me-2"></i>Plugin Backups</h6><div class="backup-list" id="pluginsBackupsList"><p class="text-muted small p-3 m-0">Loading...</p></div></div></div>
                    <div class="col-md-6"><div class="settings-section" style="border-color:var(--primary);"><h6 style="color:var(--primary);"><i class="bi bi-usb-drive me-2"></i>Flash Backups</h6><div class="backup-list" id="flashBackupsList"><p class="text-muted small p-3 m-0">Loading...</p></div></div></div>
                </div>
            </div>

            <!-- SETTINGS TAB -->
            <div class="tab-pane fade" id="settings">
                <div class="row g-4">
                    <div class="col-md-6"><div class="settings-section h-100"><h6><i class="bi bi-sliders me-2"></i>General Settings</h6>
                        <div class="mb-3"><label class="form-label">Maximum Backups</label><input type="number" class="form-control" id="maxBackups" value="{{ config.max_backups }}" min="1" max="10" style="width:100px;"></div>
                        <div class="mb-3"><label class="form-label">Naming Scheme</label><select class="form-select" id="defaultNaming" style="width:150px;"><option value="weekly" {% if config.naming_scheme == 'weekly' %}selected{% endif %}>Weekly</option><option value="daily" {% if config.naming_scheme == 'daily' %}selected{% endif %}>Daily</option><option value="monthly" {% if config.naming_scheme == 'monthly' %}selected{% endif %}>Monthly</option></select></div>
                    </div></div>
                    <div class="col-md-6"><div class="settings-section h-100"><h6><i class="bi bi-gear me-2"></i>Backup Behaviour</h6>
                        <div class="mb-3"><label class="form-label">Compression</label><select class="form-select" id="compressionLevel" style="width:180px;"><option value="1" {% if config.compression_level == 1 %}selected{% endif %}>1 - Fastest</option><option value="3" {% if config.compression_level == 3 %}selected{% endif %}>3 - Fast</option><option value="6" {% if config.compression_level == 6 or not config.compression_level %}selected{% endif %}>6 - Balanced</option><option value="9" {% if config.compression_level == 9 %}selected{% endif %}>9 - Maximum</option></select></div>
                        <div class="form-check mb-2"><input class="form-check-input" type="checkbox" id="verifyBackups" {% if config.verify_backups != false %}checked{% endif %}><label class="form-check-label" for="verifyBackups">Verify backups</label></div>
                        <div class="form-check"><input class="form-check-input" type="checkbox" id="incrementalEnabled" {% if config.incremental_enabled %}checked{% endif %}><label class="form-check-label" for="incrementalEnabled">Incremental (Appdata)</label></div>
                    </div></div>
                    <div class="col-md-6"><div class="settings-section"><h6><i class="bi bi-folder-x me-2"></i>Exclude Folders</h6><p class="text-muted small mb-2">Skip during backup:</p><div class="exclude-grid" id="excludeFoldersList"><p class="text-muted small">Loading...</p></div></div></div>
                    <div class="col-md-6"><div class="settings-section"><h6><i class="bi bi-signpost-2 me-2"></i>Paths</h6><p class="text-muted small mb-2">Docker volumes:</p>
                        <div class="path-item"><code>/backup</code><span class="text-muted">→</span><span>Destination</span></div>
                        <div class="path-item"><code>/domains</code><span class="text-muted">→</span><span>VM storage</span></div>
                        <div class="path-item"><code>/appdata</code><span class="text-muted">→</span><span>Docker data</span></div>
                        <div class="path-item"><code>/plugins</code><span class="text-muted">→</span><span>Plugins</span></div>
                        <div class="path-item"><code>/boot</code><span class="text-muted">→</span><span>Flash drive</span></div>
                    </div></div>
                </div>
                <button class="btn btn-primary w-100 mt-3" onclick="saveSettings()"><i class="bi bi-check-lg me-1"></i>Save Settings</button>
            </div>

            <!-- LOGS TAB -->
            <div class="tab-pane fade" id="logs">
                <div class="settings-section">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="mb-0"><i class="bi bi-journal-text me-2"></i>Backup Log</h6>
                        <button class="btn btn-outline-secondary btn-sm" onclick="refreshLog()"><i class="bi bi-arrow-clockwise me-1"></i>Refresh</button>
                    </div>
                    <div class="full-log" id="fullLog"><p class="text-muted">Loading...</p></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // State tracking
        const backupState = { vm: null, appdata: null, plugins: null, flash: null };
        const eventSources = { vm: null, appdata: null, plugins: null, flash: null };
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        async function apiCall(url, method = 'GET', data = null) {
            try {
                const options = { method, headers: {} };
                if (data) {
                    options.headers['Content-Type'] = 'application/json';
                    options.body = JSON.stringify(data);
                }
                const response = await fetch(url, options);
                return await response.json();
            } catch (e) {
                console.error('API Error:', e);
                return null;
            }
        }
        
        // Card log management
        function addCardLog(type, message, logType = 'normal') {
            const logEl = document.getElementById(type + 'Log');
            if (!logEl) return;
            
            const idle = logEl.querySelector('.log-idle');
            if (idle) idle.remove();
            
            const line = document.createElement('div');
            line.className = 'log-line' + (logType !== 'normal' ? ' ' + logType : '');
            line.textContent = message;
            logEl.appendChild(line);
            logEl.scrollTop = logEl.scrollHeight;
            
            // Keep only last 50 lines
            while (logEl.children.length > 50) {
                logEl.removeChild(logEl.firstChild);
            }
        }
        
        function clearCardLog(type) {
            const logEl = document.getElementById(type + 'Log');
            if (logEl) logEl.innerHTML = '<div class="log-idle">Waiting for user action…</div>';
        }
        
        function setProgress(type, percent, status = 'running') {
            const container = document.getElementById(type + 'Progress');
            const fill = document.getElementById(type + 'ProgressFill');
            const card = document.getElementById(type + 'Card');
            
            container.classList.add('active');
            fill.style.width = percent + '%';
            fill.className = 'progress-fill' + (status === 'complete' ? ' complete' : status === 'error' ? ' error' : '');
            
            if (status === 'running') {
                card.classList.add('running');
            } else {
                card.classList.remove('running');
            }
            
            if (status === 'complete' || status === 'error') {
                setTimeout(() => {
                    container.classList.remove('active');
                    fill.style.width = '0%';
                }, 5000);
            }
        }
        
        // Track current ETA for each backup
        const backupETA = { vm: '', appdata: '', plugins: '', flash: '' };
        
        function setButtonState(type, running, eta = null) {
            const btn = document.getElementById(type + 'BackupBtn');
            const labels = {
                'vm': '<i class="bi bi-play-fill me-1"></i>Start VM Backup',
                'appdata': '<i class="bi bi-play-fill me-1"></i>Start Appdata Backup',
                'plugins': '<i class="bi bi-play-fill me-1"></i>Start Plugins Backup',
                'flash': '<i class="bi bi-shield-check me-1"></i>Start Flash Backup'
            };
            
            if (running) {
                btn.disabled = true;
                if (eta) {
                    backupETA[type] = eta;
                    btn.innerHTML = `<i class="bi bi-hourglass-split me-1"></i>~${eta} remaining`;
                } else if (backupETA[type]) {
                    btn.innerHTML = `<i class="bi bi-hourglass-split me-1"></i>~${backupETA[type]} remaining`;
                } else {
                    btn.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>Starting...';
                }
            } else {
                btn.disabled = false;
                btn.innerHTML = labels[type];
                backupETA[type] = '';
            }
        }
        
        function updateGlobalStatus() {
            const running = Object.values(backupState).some(s => s && s.active);
            const dot = document.getElementById('globalStatus');
            const text = document.getElementById('globalStatusText');
            
            if (running) {
                dot.classList.add('running');
                text.textContent = 'Backup in progress';
            } else {
                dot.classList.remove('running');
                text.textContent = 'Idle';
            }
        }
        
        // SSE connection for progress streaming
        function connectSSE(type) {
            if (eventSources[type]) {
                eventSources[type].close();
            }
            
            const es = new EventSource(`/api/backup/progress/${type}`);
            eventSources[type] = es;
            
            es.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    backupState[type] = data;
                    
                    // Update progress bar
                    if (data.percent !== undefined) {
                        const status = data.complete ? 'complete' : data.error ? 'error' : 'running';
                        setProgress(type, data.percent, status);
                    }
                    
                    // Update button state with ETA
                    if (!data.complete && !data.error) {
                        setButtonState(type, true, data.eta || null);
                    }
                    
                    // Add log line
                    if (data.log) {
                        const logType = data.error ? 'error' : data.complete ? 'success' : 'normal';
                        addCardLog(type, data.log, logType);
                    }
                    
                    // Handle completion or error
                    if (data.complete || data.error) {
                        setButtonState(type, false);
                        es.close();
                        eventSources[type] = null;
                        loadStats();
                    }
                    
                    updateGlobalStatus();
                } catch (e) {
                    console.error('SSE parse error:', e);
                }
            };
            
            es.onerror = function() {
                console.log('SSE connection closed for', type);
                es.close();
                eventSources[type] = null;
                setButtonState(type, false);
                updateGlobalStatus();
            };
        }
        
        // Start backup
        async function startBackup(type) {
            clearCardLog(type);
            addCardLog(type, 'Initiating backup...');
            setButtonState(type, true);
            setProgress(type, 5);
            
            let endpoint, data;
            
            switch (type) {
                case 'vm':
                    endpoint = '/api/backup/vm';
                    data = {
                        vm_name: document.getElementById('vmSelect').value,
                        handling: document.getElementById('vmHandling').value,
                        compress: document.getElementById('vmCompress').checked,
                        naming_scheme: 'weekly'
                    };
                    break;
                case 'appdata':
                    endpoint = '/api/backup/appdata';
                    data = {
                        mode: document.querySelector('input[name="appdataMode"]:checked').value,
                        naming_scheme: 'weekly'
                    };
                    break;
                case 'plugins':
                    endpoint = '/api/backup/plugins';
                    data = { naming_scheme: 'weekly' };
                    break;
                case 'flash':
                    endpoint = '/api/backup/flash';
                    data = { naming_scheme: 'weekly' };
                    break;
            }
            
            const result = await apiCall(endpoint, 'POST', data);
            
            if (result && result.success) {
                addCardLog(type, result.message, 'success');
                connectSSE(type);
            } else {
                addCardLog(type, 'Error: ' + (result?.error || 'Unknown error'), 'error');
                setProgress(type, 100, 'error');
                setButtonState(type, false);
            }
        }
        
        function toggleDay(btn) { btn.classList.toggle('active'); }
        
        async function saveSchedule() {
            const days = [];
            document.querySelectorAll('.day-btn.active').forEach(btn => days.push(btn.dataset.day));
            
            const schedule = {
                enabled: document.getElementById('scheduleEnabled').checked,
                time: document.getElementById('scheduleTime').value,
                days: days,
                naming_scheme: document.getElementById('scheduleNaming').value,
                vm_enabled: document.getElementById('scheduleVm').checked,
                appdata_enabled: document.getElementById('scheduleAppdata').checked,
                plugins_enabled: document.getElementById('schedulePlugins').checked,
                flash_enabled: document.getElementById('scheduleFlash').checked
            };
            
            const result = await apiCall('/api/schedule', 'POST', schedule);
            if (result?.success) alert('Schedule saved!');
        }
        
        async function saveSettings() {
            const excluded = [];
            document.querySelectorAll('#excludeFoldersList input:checked').forEach(cb => excluded.push(cb.value));
            
            const settings = {
                max_backups: parseInt(document.getElementById('maxBackups').value),
                naming_scheme: document.getElementById('defaultNaming').value,
                compression_level: parseInt(document.getElementById('compressionLevel').value),
                verify_backups: document.getElementById('verifyBackups').checked,
                incremental_enabled: document.getElementById('incrementalEnabled').checked,
                exclude_folders: excluded
            };
            
            const result = await apiCall('/api/settings', 'POST', settings);
            if (result?.success) alert('Settings saved!');
        }
        
        async function loadVMs() {
            const select = document.getElementById('vmSelect');
            const vms = await apiCall('/api/vms');
            if (vms?.length > 0) {
                select.innerHTML = vms.map(vm => `<option value="${escapeHtml(vm.name)}">${escapeHtml(vm.name)} (${escapeHtml(vm.state)})</option>`).join('');
            } else {
                select.innerHTML = '<option>No VMs found</option>';
            }
        }
        
        async function loadFolders() {
            const folders = await apiCall('/api/folders');
            const countEl = document.getElementById('folderCount');
            const listEl = document.getElementById('folderList');
            const excludeEl = document.getElementById('excludeFoldersList');
            
            if (folders?.length > 0) {
                countEl.textContent = folders.length;
                listEl.innerHTML = folders.map((f, i) => `<div class="form-check"><input class="form-check-input" type="checkbox" value="${escapeHtml(f.name)}" id="folder_${i}"><label class="form-check-label small" for="folder_${i}">${escapeHtml(f.name)}</label></div>`).join('');
                excludeEl.innerHTML = folders.map((f, i) => `<div class="form-check"><input class="form-check-input" type="checkbox" value="${escapeHtml(f.name)}" id="exclude_${i}" ${f.excluded ? 'checked' : ''}><label class="form-check-label small" for="exclude_${i}">${escapeHtml(f.name)}</label></div>`).join('');
            }
        }
        
        async function loadStats() {
            const stats = await apiCall('/api/stats');
            if (stats) {
                if (stats.last_vm_backup) document.getElementById('statsLastVm').textContent = new Date(stats.last_vm_backup).toLocaleDateString();
                if (stats.last_appdata_backup) document.getElementById('statsLastAppdata').textContent = new Date(stats.last_appdata_backup).toLocaleDateString();
                document.getElementById('statsTotalSize').textContent = stats.total_backup_size_formatted || '0.0 B';
                document.getElementById('statsNextScheduled').textContent = stats.next_scheduled || '—';
            }
        }
        
        async function refreshBackupList() {
            const backups = await apiCall('/api/backups');
            if (!backups) return;
            
            ['vm', 'appdata', 'plugins', 'flash'].forEach(type => {
                const el = document.getElementById(type + 'BackupsList');
                const list = backups[type === 'vm' ? 'vms' : type];
                
                if (!list?.length) {
                    el.innerHTML = '<p class="text-muted small p-3 m-0">No backups found</p>';
                } else {
                    el.innerHTML = `<div class="backup-list-header"><span>Name</span><span>Date</span><span>Size</span><span></span></div>` +
                        list.map(b => `<div class="backup-list-item"><span class="text-truncate">${escapeHtml(b.name)}</span><span class="text-muted">${b.date}</span><span class="text-muted">${b.size}</span><button class="btn btn-outline-secondary btn-sm" onclick="restoreBackup('${type}','${escapeHtml(b.path||b.name)}')">Restore</button></div>`).join('');
                }
            });
        }
        
        async function refreshLog() {
            const result = await apiCall('/api/log?lines=100');
            const el = document.getElementById('fullLog');
            if (result?.log) {
                el.innerHTML = result.log.map(line => `<div class="log-line">${escapeHtml(line)}</div>`).join('');
                el.scrollTop = el.scrollHeight;
            }
        }
        
        async function restoreBackup(type, file) {
            if (!confirm('Restore from this backup?')) return;
            const result = await apiCall(`/api/restore/${type}`, 'POST', { backup_file: file });
            alert(result?.message || result?.error || 'Restore initiated');
        }
        
        // Init
        document.addEventListener('DOMContentLoaded', function() {
            loadVMs();
            loadFolders();
            loadStats();
            
            document.querySelectorAll('input[name="appdataMode"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    document.getElementById('folderListContainer').style.display = this.value === 'custom' ? 'block' : 'none';
                });
            });
            
            document.querySelector('button[data-bs-target="#restore"]').addEventListener('click', refreshBackupList);
            document.querySelector('button[data-bs-target="#logs"]').addEventListener('click', refreshLog);
            document.querySelector('button[data-bs-target="#settings"]').addEventListener('click', loadFolders);
        });
    </script>
</body>
</html>
