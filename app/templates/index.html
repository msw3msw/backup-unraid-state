<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Backup Unraid State</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        :root {
            --primary: #ff8c2f;
            --primary-hover: #ff9f4f;
            --bg-dark: #0a0a0a;
            --bg-card: #141414;
            --bg-input: #1a1a1a;
            --bg-log: #0d0d0d;
            --border: #2a2a2a;
            --border-highlight: #3a3a3a;
            --text: #e5e5e5;
            --text-muted: #b8b8b8;
            --success: #22c55e;
            --warning: #f59e0b;
            --error: #ef4444;
        }
        
        /* Override Bootstrap text-muted */
        .text-muted { color: #b8b8b8 !important; }
        
        * { box-sizing: border-box; }
        
        body {
            background: var(--bg-dark);
            color: var(--text);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            font-size: 14px;
            min-height: 100vh;
        }
        
        .navbar {
            background: var(--bg-card) !important;
            border-bottom: 1px solid var(--border);
            padding: 0.75rem 1.5rem;
        }
        .navbar-brand { color: var(--primary) !important; font-weight: 700; font-size: 1.1rem; }
        .status-dot {
            width: 8px; height: 8px;
            background: var(--success);
            border-radius: 50%;
            display: inline-block;
        }
        .status-dot.running { background: var(--primary); animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
        
        .nav-tabs {
            border-bottom: 1px solid var(--border);
            background: var(--bg-card);
            padding: 0 1rem;
        }
        .nav-tabs .nav-link {
            color: var(--text-muted); border: none;
            padding: 0.875rem 1.25rem; font-weight: 500; font-size: 13px;
        }
        .nav-tabs .nav-link:hover { color: var(--text); }
        .nav-tabs .nav-link.active { color: var(--primary); background: transparent; border-bottom: 2px solid var(--primary); }
        
        .main-container { max-width: 1400px; margin: 0 auto; padding: 1.5rem; }
        
        .dashboard-card {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: 12px; padding: 1rem 1.5rem; margin-bottom: 1.5rem;
        }
        .stat-row { display: flex; flex-wrap: wrap; gap: 2rem; }
        .stat-item { display: flex; gap: 0.5rem; font-size: 13px; }
        .stat-label { color: var(--text-muted); }
        .stat-value { color: var(--text); font-weight: 500; }
        
        .cards-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.5rem; }
        @media (max-width: 1024px) { .cards-grid { grid-template-columns: 1fr; } }
        
        .backup-card {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: 12px; min-height: 420px;
            display: flex; flex-direction: column; overflow: hidden;
        }
        .backup-card.critical { border-color: var(--primary); }
        .backup-card.running { border-color: var(--success); box-shadow: 0 0 20px rgba(34, 197, 94, 0.15); }
        
        .card-header-custom {
            padding: 0.875rem 1.25rem; border-bottom: 1px solid var(--border);
            font-weight: 600; font-size: 14px;
            display: flex; align-items: center; justify-content: space-between;
        }
        .card-header-custom > div:first-child {
            display: flex; align-items: center; gap: 0.5rem;
        }
        .header-status {
            font-size: 12px; font-weight: 400; color: var(--text-muted);
            font-family: monospace;
        }
        .backup-card.critical .card-header-custom { color: var(--primary); }
        .badge-critical { background: var(--error); color: #fff; font-size: 10px; padding: 2px 6px; border-radius: 4px; }
        .mode-badge { 
            font-size: 9px; 
            padding: 2px 5px; 
            border-radius: 3px; 
            margin-right: 6px; 
            font-weight: 600;
            display: inline-block;
        }
        .mode-tar { background: #4a5568; color: #fff; }
        .mode-rsync { background: #10b981; color: #fff; }
        
        .card-controls { flex: 1; padding: 1.25rem; display: flex; flex-direction: column; gap: 1rem; }
        .card-cta { padding: 0 1.25rem 1rem; }
        
        .progress-container { padding: 0 1.25rem 0.75rem; display: none; }
        .progress-container.active { display: block; }
        .progress-track { width: 100%; height: 6px; background: var(--bg-input); border-radius: 3px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--primary); border-radius: 3px; transition: width 0.3s ease; }
        .progress-fill.complete { background: var(--success); }
        .progress-fill.error { background: var(--error); }
        
        /* Current folder display */
        .current-folder {
            font-size: 12px;
            color: var(--primary);
            font-weight: 500;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .progress-eta {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 4px;
        }
        
        .card-log {
            border-top: 1px solid var(--border); background: var(--bg-log);
            padding: 0.75rem 1rem; height: 110px; overflow-y: auto;
            font-family: 'SF Mono', Monaco, 'Courier New', monospace; font-size: 11px;
        }
        .card-log::-webkit-scrollbar { width: 4px; }
        .card-log::-webkit-scrollbar-track { background: transparent; }
        .card-log::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }
        .log-line { color: var(--text-muted); line-height: 1.6; }
        .log-line.success { color: var(--success); }
        .log-line.error { color: var(--error); }
        .log-idle { color: var(--text-muted); font-style: italic; }
        
        .form-label { color: var(--text) !important; font-size: 12px; font-weight: 500; margin-bottom: 0.375rem; }
        .form-control, .form-select {
            background: var(--bg-input); border: 1px solid var(--border);
            color: var(--text); font-size: 13px; padding: 0.5rem 0.75rem; border-radius: 6px;
        }
        .form-control:focus, .form-select:focus {
            background: var(--bg-input); border-color: var(--primary);
            color: var(--text); box-shadow: 0 0 0 2px rgba(255, 140, 47, 0.15);
        }
        .form-check-input { background-color: var(--bg-input); border-color: var(--border); }
        .form-check-input:checked { background-color: var(--primary); border-color: var(--primary); }
        .form-check-label { color: var(--text) !important; font-size: 13px; }
        
        .btn-primary {
            background: var(--primary); border: none; color: #000;
            font-weight: 600; padding: 0.625rem 1rem; font-size: 13px; border-radius: 8px;
        }
        .btn-primary:hover { background: var(--primary-hover); color: #000; }
        .btn-primary:disabled { background: var(--primary); opacity: 0.6; cursor: not-allowed; }
        
        /* Cancel button style */
        .btn-cancel {
            background: var(--error); border: none; color: #fff;
            font-weight: 600; padding: 0.625rem 1rem; font-size: 13px; border-radius: 8px;
        }
        .btn-cancel:hover { background: #dc2626; color: #fff; }
        
        .btn-outline-secondary { border-color: var(--border); color: var(--text-muted); }
        .btn-outline-secondary:hover { background: var(--bg-input); border-color: var(--border-highlight); color: var(--text); }
        
        .day-btn {
            width: 40px; height: 32px; border-radius: 6px;
            border: 1px solid var(--border); background: var(--bg-input);
            color: var(--text-muted); font-size: 11px; font-weight: 600; cursor: pointer;
        }
        .day-btn:hover { border-color: var(--border-highlight); color: var(--text); }
        .day-btn.active { background: var(--primary); border-color: var(--primary); color: #000; }
        
        .settings-section {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: 12px; padding: 1.25rem; margin-bottom: 1.5rem;
        }
        .settings-section h6 { font-size: 14px; font-weight: 600; margin-bottom: 1rem; }
        
        .path-item { display: flex; align-items: center; gap: 0.75rem; padding: 0.5rem 0; font-size: 13px; }
        .path-item code { color: var(--primary); background: rgba(255, 140, 47, 0.1); padding: 2px 8px; border-radius: 4px; font-size: 12px; }
        
        .exclude-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem; max-height: 180px; overflow-y: auto; }
        @media (max-width: 768px) { .exclude-grid { grid-template-columns: repeat(2, 1fr); } }
        
        .backup-list { background: var(--bg-input); border-radius: 8px; overflow: hidden; }
        .backup-list-header {
            display: grid; grid-template-columns: 1fr 100px 70px 70px; gap: 0.5rem;
            padding: 0.5rem 0.75rem; background: var(--bg-card);
            font-size: 10px; font-weight: 600; color: var(--text-muted); text-transform: uppercase;
        }
        .backup-list-item {
            display: grid; grid-template-columns: 1fr 100px 70px 70px; gap: 0.5rem;
            padding: 0.5rem 0.75rem; border-top: 1px solid var(--border); font-size: 12px; align-items: center;
        }
        
        .full-log {
            background: var(--bg-log); border: 1px solid var(--border);
            border-radius: 8px; padding: 1rem; height: 500px; overflow-y: auto;
            font-family: 'SF Mono', Monaco, 'Courier New', monospace; font-size: 12px;
        }
        
        /* Container metadata table */
        .table-dark { --bs-table-bg: var(--bg-input); --bs-table-border-color: var(--border); }
        .table-dark thead { background: var(--bg-card); }
        .table-dark code { background: var(--bg-log); padding: 2px 6px; border-radius: 4px; color: var(--text-muted); }
        .table-dark .btn-group .btn { padding: 0.2rem 0.5rem; }
        
        /* Modal styling */
        .modal-content.bg-dark { background: var(--bg-card) !important; border: 1px solid var(--border); }
        .modal-content.bg-dark .form-check-label { color: var(--text); }
        .modal-content.bg-dark .form-check-input:checked { background-color: var(--primary); border-color: var(--primary); }
        
        /* XML list styling */
        .xml-list { background: var(--bg-input); border-radius: 8px; max-height: 300px; overflow-y: auto; }
        .xml-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 0.5rem 0.75rem; border-bottom: 1px solid var(--border); font-size: 0.85rem;
        }
        .xml-item:last-child { border-bottom: none; }
        .xml-item .xml-name { color: var(--text); }
        .xml-item .xml-status { font-size: 0.75rem; }
        .xml-item .xml-status.active { color: var(--success); }
        .xml-item .xml-status.orphan { color: var(--warning); }
        .xml-item .form-check-input { 
            width: 1.2em; height: 1.2em; margin-top: 0; cursor: pointer; 
            background-color: var(--bg-card); border: 2px solid #666;
        }
        .xml-item .form-check-input:checked { background-color: var(--primary); border-color: var(--primary); }
        .xml-item .form-check-input:disabled { opacity: 0.2; cursor: not-allowed; }
        
        /* Staging mode hint */
        .staging-hint {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 4px;
            line-height: 1.4;
        }
        .staging-hint.enabled { color: var(--success); }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="container-fluid">
            <span class="navbar-brand"><i class="bi bi-hdd-stack me-2"></i>Backup Unraid State</span>
            <span class="text-muted small">
                <span class="status-dot" id="globalStatus"></span>
                <span class="ms-2" id="globalStatusText">
                    <span id="driveStatus">Checking...</span>
                    <span class="mx-2">|</span>
                    <span id="freeSpaceStatus">—</span>
                </span>
            </span>
        </div>
    </nav>

    <ul class="nav nav-tabs" id="mainTabs">
        <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#backup"><i class="bi bi-cloud-upload me-1"></i>Backup Now</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#schedule"><i class="bi bi-clock me-1"></i>Schedule</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#restore"><i class="bi bi-cloud-download me-1"></i>Restore</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#settings"><i class="bi bi-gear me-1"></i>Settings</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#logs"><i class="bi bi-journal-text me-1"></i>Logs</button></li>
        <li class="nav-item ms-auto" id="saveSettingsTabBtn" style="display: none;">
            <button class="btn btn-primary btn-sm" onclick="saveSettings()" style="margin-top: 8px;">
                <i class="bi bi-check-lg me-1"></i>Save Settings
            </button>
        </li>
    </ul>

    <div class="main-container">
        <div class="tab-content">
            <!-- BACKUP NOW TAB -->
            <div class="tab-pane fade show active" id="backup">
                <div class="dashboard-card">
                    <div class="stat-row">
                        <div class="stat-item"><span class="stat-label">Schedule:</span><span class="stat-value" id="statsScheduleStatus">—</span></div>
                        <div class="stat-item"><span class="stat-label">Next Run:</span><span class="stat-value" id="statsNextRun">—</span></div>
                        <div class="stat-item"><span class="stat-label">Scheduled Items:</span><span class="stat-value" id="statsScheduledItems">—</span></div>
                        <div class="stat-item"><span class="stat-label">Total Backup Size:</span><span class="stat-value" id="statsTotalSize">0.0 B</span></div>
                    </div>
                </div>

                <div class="cards-grid">
                    <!-- VM Backup Card -->
                    <div class="backup-card" id="vmCard">
                        <div class="card-header-custom">
                            <div><i class="bi bi-pc-display"></i>VM Backup</div>
                            <div class="header-status" id="vmHeaderStatus">—</div>
                        </div>
                        <div class="card-controls">
                            <div><label class="form-label">Select VM</label><select class="form-select" id="vmSelect"><option>Loading...</option></select></div>
                            <div><label class="form-label">VM Handling</label><select class="form-select" id="vmHandling"><option value="stop">Stop VM during backup</option><option value="live">Live backup</option></select></div>
                            <div class="form-check"><input class="form-check-input" type="checkbox" id="vmCompress" checked><label class="form-check-label" for="vmCompress">Compress backup</label></div>
                        </div>
                        <div class="card-cta">
                            <button class="btn btn-primary w-100" id="vmBackupBtn" onclick="startBackup('vm')"><i class="bi bi-play-fill me-1"></i>Start VM Backup</button>
                        </div>
                        <div class="progress-container" id="vmProgress">
                            <div class="current-folder" id="vmCurrentFolder"></div>
                            <div class="progress-track"><div class="progress-fill" id="vmProgressFill"></div></div>
                            <div class="progress-eta" id="vmProgressEta"></div>
                        </div>
                        <div class="card-log" id="vmLog"><div class="log-idle">Waiting for user action…</div></div>
                    </div>

                    <!-- Appdata Backup Card -->
                    <div class="backup-card" id="appdataCard">
                        <div class="card-header-custom">
                            <div><i class="bi bi-folder"></i>Appdata Backup</div>
                            <div class="header-status" id="appdataHeaderStatus">—</div>
                        </div>
                        <div class="card-controls">
                            <div><label class="form-label">Backup Mode</label>
                                <div class="form-check"><input class="form-check-input" type="radio" name="appdataMode" id="appdataModeAll" value="all" checked><label class="form-check-label" for="appdataModeAll">Backup all folders (<span id="folderCount">0</span> apps)</label></div>
                                <div class="form-check"><input class="form-check-input" type="radio" name="appdataMode" id="appdataModeCustom" value="custom"><label class="form-check-label" for="appdataModeCustom">Select specific</label></div>
                            </div>
                            <div id="folderListContainer" style="display:none;"><div class="exclude-grid" id="folderList"></div></div>
                        </div>
                        <div class="card-cta">
                            <button class="btn btn-primary w-100" id="appdataBackupBtn" onclick="startBackup('appdata')"><i class="bi bi-play-fill me-1"></i>Start Appdata Backup</button>
                        </div>
                        <div class="progress-container" id="appdataProgress">
                            <div class="current-folder" id="appdataCurrentFolder"></div>
                            <div class="progress-track"><div class="progress-fill" id="appdataProgressFill"></div></div>
                            <div class="progress-eta" id="appdataProgressEta"></div>
                        </div>
                        <div class="card-log" id="appdataLog"><div class="log-idle">Waiting for user action…</div></div>
                    </div>

                    <!-- Plugins Backup Card -->
                    <div class="backup-card" id="pluginsCard">
                        <div class="card-header-custom">
                            <div><i class="bi bi-puzzle"></i>Plugins Backup</div>
                            <div class="header-status" id="pluginsHeaderStatus">—</div>
                        </div>
                        <div class="card-controls">
                            <p class="small mb-1" style="color: var(--text);">Backup all plugin configurations from:</p>
                            <p class="small mb-0" style="color: var(--text-muted); font-family: monospace;">/boot/config/plugins/</p>
                        </div>
                        <div class="card-cta">
                            <button class="btn btn-primary w-100" id="pluginsBackupBtn" onclick="startBackup('plugins')"><i class="bi bi-play-fill me-1"></i>Start Plugins Backup</button>
                        </div>
                        <div class="progress-container" id="pluginsProgress">
                            <div class="current-folder" id="pluginsCurrentFolder"></div>
                            <div class="progress-track"><div class="progress-fill" id="pluginsProgressFill"></div></div>
                            <div class="progress-eta" id="pluginsProgressEta"></div>
                        </div>
                        <div class="card-log" id="pluginsLog"><div class="log-idle">Waiting for user action…</div></div>
                    </div>

                    <!-- Flash Backup Card -->
                    <div class="backup-card critical" id="flashCard">
                        <div class="card-header-custom">
                            <div><i class="bi bi-usb-drive"></i>Flash Backup<span class="badge-critical ms-2">CRITICAL</span></div>
                            <div class="header-status" id="flashHeaderStatus">—</div>
                        </div>
                        <div class="card-controls">
                            <p class="small mb-2" style="color: var(--text);"><strong>Disaster Recovery Backup</strong></p>
                            <div class="small" style="color: #b0b0b0; line-height: 1.8;">
                                • Array configuration<br>
                                • Network settings<br>
                                • User accounts<br>
                                • Docker &amp; VM settings<br>
                                • SSL &amp; License
                            </div>
                        </div>
                        <div class="card-cta">
                            <button class="btn btn-primary w-100" id="flashBackupBtn" onclick="startBackup('flash')"><i class="bi bi-shield-check me-1"></i>Start Flash Backup</button>
                        </div>
                        <div class="progress-container" id="flashProgress">
                            <div class="current-folder" id="flashCurrentFolder"></div>
                            <div class="progress-track"><div class="progress-fill" id="flashProgressFill"></div></div>
                            <div class="progress-eta" id="flashProgressEta"></div>
                        </div>
                        <div class="card-log" id="flashLog"><div class="log-idle">Waiting for user action…</div></div>
                    </div>
                </div>
            </div>

            <!-- SCHEDULE TAB -->
            <div class="tab-pane fade" id="schedule">
                <div class="settings-section">
                    <h6><i class="bi bi-calendar-check me-2"></i>Scheduled Backups <span class="float-end text-muted small"><i class="bi bi-clock me-1"></i>Server time: <span id="serverTime">--:--:--</span></span></h6>
                    <div class="row g-4 align-items-end">
                        <div class="col-auto">
                            <label class="form-label">Enable</label>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="scheduleEnabled" {% if schedule.enabled %}checked{% endif %} style="width:2.5em;height:1.25em;">
                                <label class="form-check-label" for="scheduleEnabled">Scheduled Backups</label>
                            </div>
                        </div>
                        <div class="col-auto">
                            <label class="form-label">Time</label>
                            <input type="time" class="form-control" id="scheduleTime" value="{{ schedule.time }}" style="width:120px;">
                        </div>
                        <div class="col-auto">
                            <label class="form-label">Days</label>
                            <div class="d-flex gap-1">
                                {% for day in ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'] %}
                                <button type="button" class="day-btn {% if day.lower() in schedule.days %}active{% endif %}" data-day="{{ day.lower() }}" onclick="toggleDay(this)">{{ day }}</button>
                                {% endfor %}
                            </div>
                        </div>
                        <div class="col-auto">
                            <label class="form-label">Naming</label>
                            <select class="form-select" id="scheduleNaming" style="width:120px;">
                                <option value="weekly" {% if schedule.naming_scheme == 'weekly' %}selected{% endif %}>Weekly</option>
                                <option value="daily" {% if schedule.naming_scheme == 'daily' %}selected{% endif %}>Daily</option>
                                <option value="monthly" {% if schedule.naming_scheme == 'monthly' %}selected{% endif %}>Monthly</option>
                            </select>
                        </div>
                        <div class="col">
                            <label class="form-label">What to Backup</label>
                            <div class="d-flex flex-wrap gap-3">
                                <div class="form-check"><input class="form-check-input" type="checkbox" id="scheduleVm" {% if schedule.vm_enabled %}checked{% endif %}><label class="form-check-label" for="scheduleVm">VMs</label></div>
                                <div class="form-check"><input class="form-check-input" type="checkbox" id="scheduleAppdata" {% if schedule.appdata_enabled %}checked{% endif %}><label class="form-check-label" for="scheduleAppdata">Appdata</label></div>
                                <div class="form-check"><input class="form-check-input" type="checkbox" id="schedulePlugins" {% if schedule.plugins_enabled %}checked{% endif %}><label class="form-check-label" for="schedulePlugins">Plugins</label></div>
                                <div class="form-check"><input class="form-check-input" type="checkbox" id="scheduleFlash" {% if schedule.flash_enabled %}checked{% endif %}><label class="form-check-label" for="scheduleFlash">Flash <span class="badge-critical">Critical</span></label></div>
                            </div>
                        </div>
                    </div>
                    <button class="btn btn-primary w-100 mt-4" onclick="saveSchedule()"><i class="bi bi-check-lg me-1"></i>Save Schedule</button>
                </div>
            </div>

            <!-- RESTORE TAB -->
            <div class="tab-pane fade" id="restore">
                <div class="row g-4">
                    <!-- Container Restore Section (hidden until metadata exists) -->
                    <div class="col-12" id="containerRestoreSection" style="display: none;">
                        <div class="settings-section">
                            <h6><i class="bi bi-box-seam me-2"></i>Container Restore</h6>
                            <p class="text-muted small mb-3">Restore individual containers with option to pull images. Metadata saved during appdata backup.</p>
                            <div class="table-responsive">
                                <table class="table table-sm table-dark" style="font-size: 0.85rem;">
                                    <thead>
                                        <tr>
                                            <th>Container</th>
                                            <th>Image</th>
                                            <th>Appdata Folder</th>
                                            <th>Template</th>
                                            <th style="width: 200px;">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="containerMetadataTable">
                                        <tr><td colspan="5" class="text-muted text-center">Loading...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Existing Backups -->
                    <div class="col-md-6"><div class="settings-section"><h6><i class="bi bi-pc-display me-2"></i>VM Backups</h6><div class="backup-list" id="vmBackupsList"><p class="text-muted small p-3 m-0"><i class="bi bi-hourglass-split me-1"></i>Scanning VMs...</p></div></div></div>
                    <div class="col-md-6">
                        <div class="settings-section">
                            <h6><i class="bi bi-folder me-2"></i>Appdata Backups <i class="bi bi-info-circle text-muted" style="font-size: 0.8rem; cursor: help;" data-bs-toggle="tooltip" data-bs-placement="top" title="Restore options: Extract appdata only, or also pull all container images for disaster recovery."></i></h6>
                            <div class="backup-list" id="appdataBackupsList"><p class="text-muted small p-3 m-0"><i class="bi bi-hourglass-split me-1"></i>Scanning Appdata...</p></div>
                        </div>
                    </div>
                    <div class="col-md-6"><div class="settings-section"><h6><i class="bi bi-puzzle me-2"></i>Plugin Backups</h6><div class="backup-list" id="pluginsBackupsList"><p class="text-muted small p-3 m-0"><i class="bi bi-hourglass-split me-1"></i>Scanning Plugins...</p></div></div></div>
                    <div class="col-md-6"><div class="settings-section" style="border-color:var(--primary);"><h6 style="color:var(--primary);"><i class="bi bi-usb-drive me-2"></i>Flash Backups</h6><div class="backup-list" id="flashBackupsList"><p class="text-muted small p-3 m-0"><i class="bi bi-hourglass-split me-1"></i>Scanning Flash...</p></div></div></div>
                </div>
            </div>
            
            <!-- Appdata Restore Modal -->
            <div class="modal fade" id="appdataRestoreModal" tabindex="-1">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content bg-dark">
                        <div class="modal-header border-secondary">
                            <h6 class="modal-title"><i class="bi bi-folder me-2"></i>Restore Appdata</h6>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <p class="small text-muted mb-3">Backup: <code id="restoreModalFilename"></code></p>
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="radio" name="restoreMode" id="restoreModeAppdata" value="appdata_only" checked>
                                <label class="form-check-label" for="restoreModeAppdata">
                                    <i class="bi bi-folder me-1"></i>Restore appdata only
                                    <div class="text-muted small">Extract backup files to appdata folder</div>
                                </label>
                            </div>
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="radio" name="restoreMode" id="restoreModePull" value="pull_all">
                                <label class="form-check-label" for="restoreModePull">
                                    <i class="bi bi-cloud-download me-1"></i>Restore appdata + pull all images
                                    <div class="text-muted small">Extract backup AND pull all container images from saved metadata (for disaster recovery)</div>
                                </label>
                            </div>
                        </div>
                        <div class="modal-footer border-secondary">
                            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-primary" id="restoreModalConfirmBtn" onclick="executeAppdataRestore()"><i class="bi bi-check-lg me-1"></i>Restore</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Cancel Confirmation Modal -->
            <div class="modal fade" id="cancelConfirmModal" tabindex="-1">
                <div class="modal-dialog modal-dialog-centered modal-sm">
                    <div class="modal-content bg-dark">
                        <div class="modal-header border-secondary">
                            <h6 class="modal-title"><i class="bi bi-exclamation-triangle text-warning me-2"></i>Cancel Backup?</h6>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <p class="mb-0">Stop the backup in progress?</p>
                            <p class="text-muted small mt-2 mb-0">The current file will finish first, then any partial backups will be cleaned up.</p>
                        </div>
                        <div class="modal-footer border-secondary">
                            <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">Keep Running</button>
                            <button type="button" class="btn btn-danger btn-sm" id="cancelConfirmBtn" onclick="confirmCancel()"><i class="bi bi-stop-fill me-1"></i>Cancel Backup</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SETTINGS TAB -->
            <div class="tab-pane fade" id="settings">
                <div class="row g-4">
                    <div class="col-md-6"><div class="settings-section h-100"><h6><i class="bi bi-sliders me-2"></i>General Settings</h6>
                        <div class="mb-3"><label class="form-label">Maximum Backups</label><input type="number" class="form-control" id="maxBackups" value="{{ config.max_backups }}" min="1" max="10" style="width:100px;"></div>
                        <div class="mb-3"><label class="form-label">Naming Scheme</label><select class="form-select" id="defaultNaming" style="width:150px;"><option value="weekly" {% if config.naming_scheme == 'weekly' %}selected{% endif %}>Weekly</option><option value="daily" {% if config.naming_scheme == 'daily' %}selected{% endif %}>Daily</option><option value="monthly" {% if config.naming_scheme == 'monthly' %}selected{% endif %}>Monthly</option></select></div>
                    </div></div>
                    <div class="col-md-6"><div class="settings-section h-100"><h6><i class="bi bi-gear me-2"></i>Backup Behaviour</h6>
                        <div class="mb-3">
                            <label class="form-label">Backup Mode <span class="text-muted small">(Appdata only)</span></label>
                            <select class="form-select" id="backupMode" style="width:280px;">
                                <option value="tar" {% if not config.incremental_enabled %}selected{% endif %}>TAR - Compressed Archive</option>
                                <option value="rsync" {% if config.incremental_enabled %}selected{% endif %}>RSYNC - Fast Snapshots (Hardlinks)</option>
                            </select>
                            <small class="text-muted d-block mt-1" id="backupModeHelp"></small>
                        </div>
                        <div class="mb-3" id="compressionSection">
                            <label class="form-label">Compression</label>
                            <select class="form-select" id="compressionLevel" style="width:280px;">
                                <option value="1" {% if config.compression_level == 1 %}selected{% endif %}>1 - Fastest (approx 10 min)</option>
                                <option value="3" {% if config.compression_level == 3 %}selected{% endif %}>3 - Fast (approx 12 min)</option>
                                <option value="6" {% if config.compression_level == 6 or not config.compression_level %}selected{% endif %}>6 - Balanced (approx 15 min)</option>
                                <option value="9" {% if config.compression_level == 9 %}selected{% endif %}>9 - Maximum (approx 18 min)</option>
                            </select>
                            <small class="text-muted d-block mt-1">Times estimated for appdata with exclusions</small>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="stagingEnabled" {% if config.staging_enabled %}checked{% endif %}>
                            <label class="form-check-label" for="stagingEnabled">Use local staging <span class="text-success">(recommended)</span></label>
                            <div class="staging-hint" id="stagingHint">Backup to local disk first, then transfer to NAS. 3-5x faster!</div>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="verifyBackups" {% if config.verify_backups != false %}checked{% endif %}>
                            <label class="form-check-label" for="verifyBackups">Verify backups</label>
                        </div>
                    </div></div>
                    <div class="col-md-6"><div class="settings-section"><h6><i class="bi bi-folder-x me-2"></i>Exclude Folders</h6><p class="text-muted small mb-2">Skip during backup:</p><div class="exclude-grid" id="excludeFoldersList"><p class="text-muted small">Loading...</p></div></div></div>
                    <div class="col-md-6"><div class="settings-section"><h6><i class="bi bi-signpost-2 me-2"></i>Paths</h6><p class="text-muted small mb-2">Docker volumes:</p>
                        <div class="path-item"><code>/backup</code><span class="text-muted">→</span><span>Destination</span></div>
                        <div class="path-item"><code>/domains</code><span class="text-muted">→</span><span>VM storage</span></div>
                        <div class="path-item"><code>/appdata</code><span class="text-muted">→</span><span>Docker data</span></div>
                        <div class="path-item"><code>/plugins</code><span class="text-muted">→</span><span>Plugins</span></div>
                        <div class="path-item"><code>/boot</code><span class="text-muted">→</span><span>Flash drive</span></div>
                    </div></div>
                    <div class="col-12">
                        <div class="settings-section">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h6 class="mb-0"><i class="bi bi-file-earmark-code me-2"></i>Docker Templates (XMLs)</h6>
                                <div>
                                    <button class="btn btn-outline-danger btn-sm me-2" id="deleteSelectedXmlsBtn" onclick="deleteSelectedXmls()" style="display: none;"><i class="bi bi-trash me-1"></i>Delete Selected</button>
                                    <button class="btn btn-outline-secondary btn-sm" onclick="loadDockerXmls()"><i class="bi bi-arrow-clockwise me-1"></i>Refresh</button>
                                </div>
                            </div>
                            <p class="text-muted small mb-2">Manage container templates on flash drive. <span class="text-warning"><i class="bi bi-exclamation-triangle me-1"></i>Detection may not be 100% accurate - verify before deleting.</span></p>
                            <div class="xml-list" id="dockerXmlList"><p class="text-muted small">Click refresh to load...</p></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- LOGS TAB -->
            <div class="tab-pane fade" id="logs">
                <div class="settings-section">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="mb-0"><i class="bi bi-journal-text me-2"></i>Backup Log</h6>
                        <button class="btn btn-outline-secondary btn-sm" onclick="refreshLog()"><i class="bi bi-arrow-clockwise me-1"></i>Refresh</button>
                    </div>
                    <div class="full-log" id="fullLog"><p class="text-muted">Loading...</p></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // State tracking
        const backupState = { vm: null, appdata: null, plugins: null, flash: null };
        const eventSources = { vm: null, appdata: null, plugins: null, flash: null };
        const backupETA = { vm: '', appdata: '', plugins: '', flash: '' };
        const backupPhase = { vm: '', appdata: '', plugins: '', flash: '' };
        let pendingCancelType = null;
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        async function apiCall(url, method = 'GET', data = null) {
            try {
                const options = { method, headers: {} };
                if (data) {
                    options.headers['Content-Type'] = 'application/json';
                    options.body = JSON.stringify(data);
                }
                const response = await fetch(url, options);
                return await response.json();
            } catch (e) {
                console.error('API Error:', e);
                return null;
            }
        }
        
        // Card log management
        function addCardLog(type, message, logType = 'normal') {
            const logEl = document.getElementById(type + 'Log');
            if (!logEl) return;
            
            const idle = logEl.querySelector('.log-idle');
            if (idle) idle.remove();
            
            const line = document.createElement('div');
            line.className = 'log-line' + (logType !== 'normal' ? ' ' + logType : '');
            line.textContent = message;
            logEl.appendChild(line);
            logEl.scrollTop = logEl.scrollHeight;
            
            // Keep only last 50 lines
            while (logEl.children.length > 50) {
                logEl.removeChild(logEl.firstChild);
            }
        }
        
        function clearCardLog(type) {
            const logEl = document.getElementById(type + 'Log');
            if (logEl) logEl.innerHTML = '';
        }
        
        function setProgress(type, percent, status = 'running') {
            const container = document.getElementById(type + 'Progress');
            const fill = document.getElementById(type + 'ProgressFill');
            const card = document.getElementById(type + 'Card');
            
            if (container && fill) {
                container.classList.add('active');
                fill.style.width = percent + '%';
                fill.className = 'progress-fill ' + (status === 'complete' ? 'complete' : status === 'error' ? 'error' : '');
            }
            
            if (card) {
                if (status === 'running' && percent < 100) {
                    card.classList.add('running');
                } else {
                    card.classList.remove('running');
                }
            }
        }
        
        // Update current folder display
        function updateCurrentFolder(type, phase, eta) {
            const folderEl = document.getElementById(type + 'CurrentFolder');
            const etaEl = document.getElementById(type + 'ProgressEta');
            
            if (folderEl && phase) {
                folderEl.textContent = phase;
            }
            
            if (etaEl) {
                if (eta && eta.startsWith('elapsed:')) {
                    etaEl.textContent = eta.replace('elapsed:', '') + ' elapsed';
                } else if (eta) {
                    etaEl.textContent = '~' + eta + ' remaining';
                } else {
                    etaEl.textContent = '';
                }
            }
        }
        
        // Button states with cancel support
        function setButtonState(type, running, eta = null, phase = null) {
            const btn = document.getElementById(type + 'BackupBtn');
            if (!btn) return;
            
            const startLabels = {
                'vm': '<i class="bi bi-play-fill me-1"></i>Start VM Backup',
                'appdata': '<i class="bi bi-play-fill me-1"></i>Start Appdata Backup',
                'plugins': '<i class="bi bi-play-fill me-1"></i>Start Plugins Backup',
                'flash': '<i class="bi bi-shield-check me-1"></i>Start Flash Backup'
            };
            
            if (running) {
                if (phase) backupPhase[type] = phase;
                if (eta) backupETA[type] = eta;
                
                // Update current folder display
                updateCurrentFolder(type, phase, eta);
                
                // Show cancel button
                btn.className = 'btn btn-cancel w-100';
                btn.innerHTML = '<i class="bi bi-stop-fill me-1"></i>Cancel Backup';
                btn.onclick = function() { requestCancel(type); };
                btn.disabled = false;
            } else {
                // Show start button
                btn.className = 'btn btn-primary w-100';
                btn.innerHTML = startLabels[type];
                btn.onclick = function() { startBackup(type); };
                btn.disabled = false;
                backupETA[type] = '';
                backupPhase[type] = '';
                
                // Clear current folder display
                updateCurrentFolder(type, '', '');
            }
        }
        
        function updateGlobalStatus() {
            const running = Object.values(backupState).some(s => s && s.active);
            const dot = document.getElementById('globalStatus');
            
            if (running) {
                dot.classList.add('running');
            } else {
                dot.classList.remove('running');
            }
        }
        
        // Cancel backup request
        function requestCancel(type) {
            pendingCancelType = type;
            const modal = new bootstrap.Modal(document.getElementById('cancelConfirmModal'));
            modal.show();
        }
        
        async function confirmCancel() {
            if (!pendingCancelType) return;
            
            const type = pendingCancelType;
            pendingCancelType = null;
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('cancelConfirmModal'));
            if (modal) modal.hide();
            
            // Update button to show cancelling
            const btn = document.getElementById(type + 'BackupBtn');
            if (btn) {
                btn.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>Cancelling...';
                btn.disabled = true;
            }
            
            // Send cancel request
            const result = await apiCall(`/api/backup/cancel/${type}`, 'POST');
            
            if (result && result.success) {
                addCardLog(type, 'Cancel requested - cleaning up...', 'warning');
            } else {
                addCardLog(type, 'Failed to cancel: ' + (result?.error || 'Unknown error'), 'error');
                // Re-enable button
                setButtonState(type, true, backupETA[type], backupPhase[type]);
            }
        }
        
        // SSE connection for progress streaming
        function connectSSE(type) {
            if (eventSources[type]) {
                eventSources[type].close();
            }
            
            const es = new EventSource(`/api/backup/progress/${type}`);
            eventSources[type] = es;
            
            es.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    backupState[type] = data;
                    
                    // Update progress bar
                    if (data.percent !== undefined) {
                        const status = data.complete ? 'complete' : data.error ? 'error' : 'running';
                        setProgress(type, data.percent, status);
                    }
                    
                    // Update button state with ETA and phase
                    if (!data.complete && !data.error) {
                        setButtonState(type, true, data.eta || null, data.phase || null);
                    }
                    
                    // Add log line
                    if (data.log) {
                        const logType = data.error ? 'error' : data.complete ? 'success' : 'normal';
                        addCardLog(type, data.log, logType);
                    }
                    
                    // Handle completion or error
                    if (data.complete || data.error) {
                        setButtonState(type, false);
                        es.close();
                        eventSources[type] = null;
                        loadStats();
                        
                        // Update card header with last backup info (delay to ensure file is written)
                        if (data.complete) {
                            setTimeout(() => updateCardHeader(type), 2000);
                        }
                    }
                    
                    updateGlobalStatus();
                } catch (e) {
                    console.error('SSE parse error:', e);
                }
            };
            
            es.onerror = function() {
                console.log('SSE connection closed for', type);
                es.close();
                eventSources[type] = null;
                setButtonState(type, false);
                updateGlobalStatus();
            };
        }
        
        // Start backup
        async function startBackup(type) {
            // Quick validation check (status already shown in header)
            const validation = await apiCall('/api/validate-backup');
            if (!validation || (!validation.valid && validation.issues && validation.issues.length > 0)) {
                clearCardLog(type);
                addCardLog(type, '❌ Cannot start backup - check drive status in header', 'error');
                if (validation && validation.issues) {
                    validation.issues.forEach(issue => addCardLog(type, '  • ' + issue, 'error'));
                }
                return;
            }
            
            // Start backup immediately
            clearCardLog(type);
            addCardLog(type, 'Initiating backup...');
            setButtonState(type, true, null, 'Starting...');
            setProgress(type, 5);
            
            let endpoint, data;
            
            switch (type) {
                case 'vm':
                    endpoint = '/api/backup/vm';
                    data = {
                        vm_name: document.getElementById('vmSelect').value,
                        handling: document.getElementById('vmHandling').value,
                        compress: document.getElementById('vmCompress').checked,
                        naming_scheme: 'weekly'
                    };
                    break;
                case 'appdata':
                    endpoint = '/api/backup/appdata';
                    data = {
                        mode: document.querySelector('input[name="appdataMode"]:checked').value,
                        naming_scheme: 'weekly'
                    };
                    break;
                case 'plugins':
                    endpoint = '/api/backup/plugins';
                    data = { naming_scheme: 'weekly' };
                    break;
                case 'flash':
                    endpoint = '/api/backup/flash';
                    data = { naming_scheme: 'weekly' };
                    break;
            }
            
            const result = await apiCall(endpoint, 'POST', data);
            
            if (result && result.success) {
                addCardLog(type, result.message, 'success');
                connectSSE(type);
            } else {
                addCardLog(type, 'Error: ' + (result?.error || 'Unknown error'), 'error');
                setProgress(type, 100, 'error');
                setButtonState(type, false);
            }
        }
        
        function toggleDay(btn) { btn.classList.toggle('active'); }
        
        async function saveSchedule() {
            const days = [];
            document.querySelectorAll('.day-btn.active').forEach(btn => days.push(btn.dataset.day));
            
            const schedule = {
                enabled: document.getElementById('scheduleEnabled').checked,
                time: document.getElementById('scheduleTime').value,
                days: days,
                naming_scheme: document.getElementById('scheduleNaming').value,
                vm_enabled: document.getElementById('scheduleVm').checked,
                appdata_enabled: document.getElementById('scheduleAppdata').checked,
                plugins_enabled: document.getElementById('schedulePlugins').checked,
                flash_enabled: document.getElementById('scheduleFlash').checked
            };
            
            const result = await apiCall('/api/schedule', 'POST', schedule);
            if (result?.success) {
                alert('Schedule saved!');
                loadStats();  // Refresh stats to show next scheduled
            }
        }
        
        async function saveSettings() {
            const excluded = [];
            document.querySelectorAll('#excludeFoldersList input:checked').forEach(cb => excluded.push(cb.value));
            
            const backupMode = document.getElementById('backupMode').value;
            
            const settings = {
                max_backups: parseInt(document.getElementById('maxBackups').value),
                naming_scheme: document.getElementById('defaultNaming').value,
                compression_level: parseInt(document.getElementById('compressionLevel').value),
                verify_backups: document.getElementById('verifyBackups').checked,
                incremental_enabled: (backupMode === 'rsync'),
                staging_enabled: document.getElementById('stagingEnabled').checked,
                exclude_folders: excluded
            };
            
            const result = await apiCall('/api/settings', 'POST', settings);
            if (result?.success) alert('Settings saved!');
        }
        
        async function loadDockerXmls() {
            const listEl = document.getElementById('dockerXmlList');
            listEl.innerHTML = '<p class="text-muted small p-3 m-0">Loading...</p>';
            
            const result = await apiCall('/api/docker-xmls');
            
            if (!result?.xmls?.length) {
                listEl.innerHTML = '<p class="text-muted small p-3 m-0">No Docker templates found</p>';
                document.getElementById('deleteSelectedXmlsBtn').style.display = 'none';
                return;
            }
            
            listEl.innerHTML = result.xmls.map(xml => `
                <div class="xml-item">
                    <div class="d-flex align-items-center">
                        <input type="checkbox" class="form-check-input me-2 xml-checkbox" 
                               data-filename="${escapeHtml(xml.filename)}" 
                               ${xml.has_container ? 'disabled' : ''}
                               onchange="updateDeleteButton()">
                        <span class="xml-name"><i class="bi bi-file-earmark-code me-2"></i>${escapeHtml(xml.name)}</span>
                        <span class="xml-status ${xml.has_container ? 'active' : 'orphan'} ms-2">
                            ${xml.has_container ? '<i class="bi bi-check-circle"></i> Active' : '<i class="bi bi-exclamation-triangle"></i> No container'}
                        </span>
                    </div>
                </div>
            `).join('');
            
            updateDeleteButton();
        }
        
        function updateDeleteButton() {
            const checked = document.querySelectorAll('.xml-checkbox:checked').length;
            const btn = document.getElementById('deleteSelectedXmlsBtn');
            if (checked > 0) {
                btn.style.display = 'inline-block';
                btn.innerHTML = `<i class="bi bi-trash me-1"></i>Delete Selected (${checked})`;
            } else {
                btn.style.display = 'none';
            }
        }
        
        async function deleteSelectedXmls() {
            const checkboxes = document.querySelectorAll('.xml-checkbox:checked');
            const filenames = Array.from(checkboxes).map(cb => cb.dataset.filename);
            
            if (filenames.length === 0) return;
            
            if (!confirm(`Delete ${filenames.length} template(s)?\n\n⚠️ VERIFY these templates are truly orphaned before deleting.\nDetection may not be 100% accurate.\n\nThis will permanently remove them from your flash drive.`)) return;
            
            const result = await apiCall('/api/docker-xmls', 'DELETE', { filenames: filenames });
            
            if (result?.success) {
                const msg = result.deleted?.length ? `Deleted: ${result.deleted.length}` : '';
                const errMsg = result.errors?.length ? `\nErrors: ${result.errors.join(', ')}` : '';
                alert(msg + errMsg || 'Done');
                loadDockerXmls();
            } else {
                alert(`Failed: ${result?.error || 'Unknown error'}`);
            }
        }
        
        async function deleteDockerXml(filename) {
            if (!confirm(`Delete template: ${filename}?\n\n⚠️ VERIFY this template is truly orphaned before deleting.\nDetection may not be 100% accurate.\n\nThis will permanently remove it from your flash drive.`)) return;
            
            const result = await apiCall('/api/docker-xmls', 'DELETE', { filename: filename });
            
            if (result?.success) {
                alert('Template deleted');
                loadDockerXmls();
            } else {
                alert(`Failed to delete: ${result?.error || 'Unknown error'}`);
            }
        }
        
        async function loadVMs() {
            const select = document.getElementById('vmSelect');
            const vms = await apiCall('/api/vms');
            if (vms?.length > 0) {
                select.innerHTML = vms.map(vm => `<option value="${escapeHtml(vm.name)}">${escapeHtml(vm.name)} (${escapeHtml(vm.state)})</option>`).join('');
            } else {
                select.innerHTML = '<option>No VMs found</option>';
            }
        }
        
        async function loadFolders() {
            const folders = await apiCall('/api/folders');
            const config = await apiCall('/api/settings');
            const excluded = config?.exclude_folders || [];
            
            if (folders?.length > 0) {
                document.getElementById('folderCount').textContent = folders.length;
                
                // Folder list for custom backup selection
                const folderList = document.getElementById('folderList');
                folderList.innerHTML = folders.map(f => `
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="${escapeHtml(f.name)}" id="folder-${escapeHtml(f.name)}">
                        <label class="form-check-label" for="folder-${escapeHtml(f.name)}">${escapeHtml(f.name)}</label>
                    </div>
                `).join('');
                
                // Exclude list for settings
                const excludeList = document.getElementById('excludeFoldersList');
                excludeList.innerHTML = folders.map(f => `
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="${escapeHtml(f.name)}" 
                               id="exclude-${escapeHtml(f.name)}" ${excluded.includes(f.name) ? 'checked' : ''}>
                        <label class="form-check-label" for="exclude-${escapeHtml(f.name)}">${escapeHtml(f.name)}</label>
                    </div>
                `).join('');
            }
        }
        
        async function loadStats() {
            const stats = await apiCall('/api/stats');
            const schedule = await apiCall('/api/schedule');
            
            if (stats) {
                document.getElementById('statsTotalSize').textContent = formatBytes(stats.total_backup_size || 0);
            }
            
            if (schedule) {
                // Schedule status
                const enabled = schedule.enabled;
                document.getElementById('statsScheduleStatus').innerHTML = enabled 
                    ? '<span class="text-success">Enabled</span>' 
                    : '<span class="text-muted">Disabled</span>';
                
                // Next run time
                if (enabled && stats?.next_scheduled) {
                    document.getElementById('statsNextRun').textContent = stats.next_scheduled;
                } else {
                    document.getElementById('statsNextRun').textContent = '—';
                }
                
                // What's being backed up
                const items = [];
                if (schedule.vm_enabled) items.push('VMs');
                if (schedule.appdata_enabled) items.push('Appdata');
                if (schedule.plugins_enabled) items.push('Plugins');
                if (schedule.flash_enabled) items.push('Flash');
                
                document.getElementById('statsScheduledItems').textContent = items.length > 0 ? items.join(', ') : '—';
            }
        }
        
        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }
        
        async function updateCardHeader(type) {
            // Don't update header if backup is currently active for this type
            if (backupState[type]?.active || eventSources[type]) {
                return; // Skip - will update when backup completes
            }
            
            // Fetch latest backup info for this type
            const typeMap = {vm: 'vms', appdata: 'appdata', plugins: 'plugins', flash: 'flash'};
            const backups = await apiCall(`/api/backups/${typeMap[type]}`);
            
            const headerEl = document.getElementById(`${type}HeaderStatus`);
            if (backups && backups.length > 0) {
                const latest = backups[0];
                headerEl.textContent = `${latest.date} • ${latest.size}`;
            } else {
                headerEl.textContent = '—';
            }
        }
        
        async function loadAllCardHeaders() {
            updateCardHeader('vm');
            updateCardHeader('appdata');
            updateCardHeader('plugins');
            updateCardHeader('flash');
        }
        
        async function updateDriveStatus() {
            const result = await apiCall('/api/validate-backup');
            const statusEl = document.getElementById('driveStatus');
            const freeEl = document.getElementById('freeSpaceStatus');
            const dot = document.getElementById('globalStatus');
            
            if (result?.valid) {
                statusEl.innerHTML = '<span class="text-success">Connected</span>';
                freeEl.textContent = result.free_space + ' free';
                dot.style.background = 'var(--success)';
            } else {
                statusEl.innerHTML = '<span class="text-danger">Disconnected</span>';
                freeEl.textContent = result?.issues?.[0] || 'Check backup destination';
                dot.style.background = 'var(--error)';
            }
        }
        
        async function refreshBackupList() {
            // Load each backup type independently for faster UI feedback
            const loadBackupType = async (type, listId, emptyMsg) => {
                try {
                    const data = await apiCall(`/api/backups/${type}`);
                    const listEl = document.getElementById(listId);
                    
                    if (data?.length) {
                        if (type === 'appdata') {
                            listEl.innerHTML = `<div class="backup-list-header"><span>Name</span><span>Date</span><span>Size</span><span></span></div>` +
                                data.map(b => `
                                    <div class="backup-list-item">
                                        <span><span class="mode-badge ${b.mode === 'rsync' ? 'mode-rsync' : 'mode-tar'}">${b.mode?.toUpperCase()}</span>${escapeHtml(b.name)}</span>
                                        <span class="text-muted">${b.date}</span>
                                        <span>${b.size}</span>
                                        <span><button class="btn btn-outline-secondary btn-sm" onclick="showAppdataRestoreModal('${escapeHtml(b.path)}','${escapeHtml(b.name)}')">Restore</button></span>
                                    </div>
                                `).join('');
                        } else if (type === 'flash') {
                            listEl.innerHTML = `<div class="backup-list-header"><span>Name</span><span>Date</span><span>Size</span><span></span></div>` +
                                data.map(b => `
                                    <div class="backup-list-item">
                                        <span>${escapeHtml(b.name)}</span>
                                        <span class="text-muted">${b.date}</span>
                                        <span>${b.size}</span>
                                        <span><button class="btn btn-outline-secondary btn-sm" disabled data-bs-toggle="tooltip" title="Manual restore - see RESTORE_INSTRUCTIONS.txt">Manual</button></span>
                                    </div>
                                `).join('');
                        } else {
                            listEl.innerHTML = `<div class="backup-list-header"><span>Name</span><span>Date</span><span>Size</span><span></span></div>` +
                                data.map(b => `
                                    <div class="backup-list-item">
                                        <span>${escapeHtml(b.name)}</span>
                                        <span class="text-muted">${b.date}</span>
                                        <span>${b.size}</span>
                                        <span><button class="btn btn-outline-secondary btn-sm" onclick="restoreBackup('${type === 'vms' ? 'vm' : type}','${escapeHtml(b.path)}')">Restore</button></span>
                                    </div>
                                `).join('');
                        }
                    } else {
                        listEl.innerHTML = `<p class="text-muted small p-3 m-0">${emptyMsg}</p>`;
                    }
                } catch (e) {
                    document.getElementById(listId).innerHTML = '<p class="text-muted small p-3 m-0">Error scanning</p>';
                }
            };
            
            // Fire all requests in parallel - each updates its own card when done
            loadBackupType('vms', 'vmBackupsList', 'No VM backups found');
            loadBackupType('appdata', 'appdataBackupsList', 'No appdata backups found');
            loadBackupType('plugins', 'pluginsBackupsList', 'No plugin backups found');
            loadBackupType('flash', 'flashBackupsList', 'No flash backups found');
            
            // Load container metadata (doesn't block the above)
            loadContainerMetadata();
        }
        
        let currentRestoreBackup = null;
        
        function showAppdataRestoreModal(backupPath, backupName) {
            currentRestoreBackup = backupPath;
            document.getElementById('restoreModalFilename').textContent = backupName;
            const modal = new bootstrap.Modal(document.getElementById('appdataRestoreModal'));
            modal.show();
        }
        
        async function executeAppdataRestore() {
            if (!currentRestoreBackup) return;
            
            const mode = document.querySelector('input[name="restoreMode"]:checked').value;
            const btn = document.getElementById('restoreModalConfirmBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>Restoring...';
            btn.disabled = true;
            
            const result = await apiCall('/api/restore/appdata', 'POST', {
                backup_source: currentRestoreBackup,
                folder: '',
                mode: mode === 'pull_all' ? 'pull_image' : 'appdata_only'
            });
            
            btn.innerHTML = originalText;
            btn.disabled = false;
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('appdataRestoreModal'));
            modal.hide();
            
            if (result?.success) {
                alert('Restore completed successfully!');
            } else {
                alert('Restore failed: ' + (result?.error || 'Unknown error'));
            }
            
            currentRestoreBackup = null;
        }
        
        async function loadContainerMetadata() {
            const result = await apiCall('/api/container-metadata');
            const section = document.getElementById('containerRestoreSection');
            const table = document.getElementById('containerMetadataTable');
            
            if (!result?.containers?.length) {
                section.style.display = 'none';
                return;
            }
            
            section.style.display = 'block';
            table.innerHTML = result.containers.map(c => `
                <tr>
                    <td><strong>${escapeHtml(c.container_name)}</strong></td>
                    <td><code class="small">${escapeHtml(c.image || 'Unknown')}</code></td>
                    <td>${escapeHtml(c.appdata_folder || '—')}</td>
                    <td>${c.template ? '<i class="bi bi-check-circle text-success"></i>' : '<i class="bi bi-x-circle text-muted"></i>'}</td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            ${c.appdata_folder ? `<button class="btn btn-outline-secondary" onclick="restoreContainer('${escapeHtml(c.appdata_folder)}','appdata_only')" data-bs-toggle="tooltip" title="Restore appdata only"><i class="bi bi-folder"></i></button>` : ''}
                            ${c.image ? `<button class="btn btn-outline-primary" onclick="restoreContainer('${escapeHtml(c.appdata_folder)}','pull_image')" data-bs-toggle="tooltip" title="Pull image + restore appdata"><i class="bi bi-cloud-download"></i></button>` : ''}
                            ${c.image ? `<button class="btn btn-outline-success" onclick="pullImage('${escapeHtml(c.image)}')" data-bs-toggle="tooltip" title="Pull image only"><i class="bi bi-download"></i></button>` : ''}
                        </div>
                    </td>
                </tr>
            `).join('');
            
            // Initialize tooltips on new elements
            document.querySelectorAll('#containerMetadataTable [data-bs-toggle="tooltip"]').forEach(el => new bootstrap.Tooltip(el));
        }
        
        async function restoreContainer(folder, mode) {
            const modeLabels = {
                'appdata_only': 'Restore appdata only',
                'pull_image': 'Pull image and restore appdata',
                'full_restore': 'Full restore (stop container, pull, restore)'
            };
            
            if (!confirm(`${modeLabels[mode]} for ${folder}?`)) return;
            
            // Find latest backup source
            const backups = await apiCall('/api/backups');
            let backupSource = '';
            
            // Check for incremental snapshots first
            if (backups?.appdata?.length) {
                for (const b of backups.appdata) {
                    if (b.path?.includes('snapshots')) {
                        backupSource = b.path;
                        break;
                    }
                }
                // Fall back to tar archive
                if (!backupSource) {
                    backupSource = backups.appdata[0].path || backups.appdata[0].name;
                }
            }
            
            if (!backupSource) {
                alert('No appdata backup found');
                return;
            }
            
            const result = await apiCall('/api/restore/appdata', 'POST', {
                backup_source: backupSource,
                folder: folder,
                mode: mode
            });
            
            if (result?.success) {
                alert(`Restore completed for ${folder}`);
            } else {
                alert(`Restore failed: ${result?.error || 'Unknown error'}`);
            }
        }
        
        async function pullImage(image) {
            if (!confirm(`Pull image: ${image}?`)) return;
            
            const btn = event.target.closest('button');
            const originalHtml = btn.innerHTML;
            btn.innerHTML = '<i class="bi bi-hourglass-split"></i>';
            btn.disabled = true;
            
            const result = await apiCall('/api/restore/pull-image', 'POST', { image: image });
            
            btn.innerHTML = originalHtml;
            btn.disabled = false;
            
            if (result?.success) {
                alert(`Image pulled successfully: ${image}`);
            } else {
                alert(`Pull failed: ${result?.error || 'Unknown error'}`);
            }
        }
        
        async function refreshLog() {
            const result = await apiCall('/api/log?lines=100');
            const el = document.getElementById('fullLog');
            if (result?.log) {
                el.innerHTML = result.log.map(line => `<div class="log-line">${escapeHtml(line)}</div>`).join('');
                el.scrollTop = el.scrollHeight;
            }
        }
        
        async function restoreBackup(type, file) {
            if (!confirm('Restore from this backup?')) return;
            const result = await apiCall(`/api/restore/${type}`, 'POST', { backup_file: file });
            alert(result?.message || result?.error || 'Restore initiated');
        }
        
        // Init
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize Bootstrap tooltips
            const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
            tooltipTriggerList.forEach(el => new bootstrap.Tooltip(el));
            
            // Fix Bootstrap modal aria-hidden issue that prevents button clicks
            const appdataModal = document.getElementById('appdataRestoreModal');
            if (appdataModal) {
                appdataModal.addEventListener('shown.bs.modal', function() {
                    // Remove aria-hidden from modal and its children to fix click issues
                    this.removeAttribute('aria-hidden');
                    this.querySelectorAll('[aria-hidden]').forEach(el => el.removeAttribute('aria-hidden'));
                });
            }
            
            loadVMs();
            loadFolders();
            loadStats();
            updateDriveStatus();
            loadAllCardHeaders();
            
            // Pre-load restore tab backups in background (so they're ready when user clicks Restore)
            setTimeout(() => refreshBackupList(), 1000);
            
            // Update server time every second
            async function updateServerTime() {
                try {
                    const data = await apiCall('/api/server-time');
                    if (data?.time) {
                        document.getElementById('serverTime').textContent = data.time;
                    }
                } catch (e) {}
            }
            updateServerTime();
            setInterval(updateServerTime, 1000);
            
            // Refresh drive status every 30 seconds
            setInterval(updateDriveStatus, 30000);
            
            // Show/hide Save Settings button based on active tab
            document.querySelectorAll('[data-bs-toggle="tab"]').forEach(tab => {
                tab.addEventListener('shown.bs.tab', function (event) {
                    const target = event.target.getAttribute('data-bs-target');
                    const saveBtn = document.getElementById('saveSettingsTabBtn');
                    if (target === '#settings') {
                        saveBtn.style.display = 'block';
                    } else {
                        saveBtn.style.display = 'none';
                    }
                });
            });
            
            document.querySelectorAll('input[name="appdataMode"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    document.getElementById('folderListContainer').style.display = this.value === 'custom' ? 'block' : 'none';
                });
            });
            
            // Backup Mode handler - show/hide compression and update help text
            function updateBackupModeUI() {
                const backupMode = document.getElementById('backupMode').value;
                const compressionSection = document.getElementById('compressionSection');
                const helpText = document.getElementById('backupModeHelp');
                
                if (backupMode === 'tar') {
                    compressionSection.style.display = 'block';
                    helpText.textContent = 'Appdata only: Creates compressed .tar.gz files. VMs/Plugins/Flash always use TAR. Approx 10-18 min.';
                } else {
                    compressionSection.style.display = 'none';
                    helpText.textContent = 'Appdata only: Fast snapshots with hardlinks. VMs/Plugins/Flash always use TAR. First: ~5-10 min, Subsequent: ~30 sec.';
                }
            }
            
            document.getElementById('backupMode').addEventListener('change', updateBackupModeUI);
            updateBackupModeUI(); // Initialize on page load
            
            // Staging mode hint update
            function updateStagingHint() {
                const enabled = document.getElementById('stagingEnabled').checked;
                const hint = document.getElementById('stagingHint');
                if (enabled) {
                    hint.textContent = '✓ Staging enabled - backups will be 3-5x faster!';
                    hint.className = 'staging-hint enabled';
                } else {
                    hint.textContent = 'Backup to local disk first, then transfer to NAS. 3-5x faster!';
                    hint.className = 'staging-hint';
                }
            }
            
            document.getElementById('stagingEnabled').addEventListener('change', updateStagingHint);
            updateStagingHint();
            
            document.querySelector('button[data-bs-target="#restore"]').addEventListener('click', refreshBackupList);
            document.querySelector('button[data-bs-target="#logs"]').addEventListener('click', refreshLog);
            document.querySelector('button[data-bs-target="#settings"]').addEventListener('click', loadFolders);
        });
    </script>
</body>
</html>
